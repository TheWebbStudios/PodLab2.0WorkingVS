<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PodLab Packet Builder v2.0</title>

  <!-- Shared external CSS for live preview and builder UI.
       Note: the DOWNLOADED packet will inline CSS (Section 5 script) so formatting persists. -->
  <link rel="stylesheet" href="packet.css" />
</head>
<body>

  <!-- Page header: simple, teachable intro -->
  <h1>üéôÔ∏è PodLab Packet Builder v2.0</h1>
  <p>This builder generates a branded, self-contained episode packet. You can add segments dynamically, script or riff, and produce outreach emails with recording details.</p>

  <!-- Two-column layout container.
       We'll enable independent scrolling in CSS by constraining height and using overflow.
       Structure now; CSS tweaks later in Section 5 script or your packet.css. -->
  <div class="container">
    <!-- Left column: the form panel. Will scroll independently. -->
    <div class="form-panel">
      <h2>üìã Episode details</h2>

      <!-- Logo upload (embedded as base64 into the packet HTML in Section 5 script) -->
      <label for="logo">Upload logo (PNG/JPG)</label>
      <input type="file" id="logo" accept="image/png, image/jpeg" />
      <button type="button" onclick="clearLogo()">Clear logo</button>
      <small>Optional. The logo appears at the top of the packet.</small>

      <!-- Brand kit: colors and font selection -->
      <h3>üé® Brand kit</h3>
      <label for="brandPrimary">Primary color</label>
      <div class="color-picker">
        <input type="color" id="brandPrimary" value="#ffd56a" oninput="updateColorPreview('brandPrimaryPreview', this.value)" />
        <span id="brandPrimaryPreview" class="color-preview"></span>
      </div>
      <small>Used for main headings and important elements. This color sets the primary visual tone of your packet.</small>

      <label for="brandAccent">Secondary accent color</label>
      <div class="color-picker">
        <input type="color" id="brandAccent" value="#5cc8ff" oninput="updateColorPreview('brandAccentPreview', this.value)" />
        <span id="brandAccentPreview" class="color-preview"></span>
      </div>
      <small>Applied to subheadings and interactive elements. Creates visual hierarchy and highlights key information.</small>

      <label for="brandBackground">Background color</label>
      <div class="color-picker">
        <input type="color" id="brandBackground" value="#0f1115" oninput="updateColorPreview('brandBackgroundPreview', this.value)" />
        <span id="brandBackgroundPreview" class="color-preview"></span>
      </div>
      <small>Sets the base canvas color. Choose a color that ensures good readability with your text and maintains visual comfort.</small>

      <label for="brandText">Text style</label>
      <div class="text-style-picker">
        <input type="color" id="brandText" value="#ffffff" oninput="updateTextStylePreview()" />
        <select id="brandFont" onchange="updateTextStylePreview()">
          <option value="Inter, system-ui, -apple-system, sans-serif">Inter / System</option>
          <option value="Georgia, serif">Georgia</option>
          <option value="'Segoe UI', Tahoma, Geneva, Verdana, sans-serif">Segoe UI</option>
          <option value="'Helvetica Neue', Arial, sans-serif">Helvetica</option>
        </select>
        <span id="brandTextPreview" class="text-style-preview">Aa</span>
      </div>
      <small>Controls the default text color and font used throughout your packet.</small>
      
      <div class="brand-kit-note">
        <small>All brand choices will be embedded in the exported packet to ensure consistent styling across devices.</small>
      </div>

      <!-- Title drives the packet filename and <h1> -->
      <label for="title">Episode title</label>
      <input type="text" id="title" placeholder="e.g., Atlas Watch ‚Äî The First Light" />

      <!-- Description is a short summary under the title -->
      <label for="description">Episode description</label>
      <textarea id="description" rows="3" placeholder="Brief summary of the episode focus"></textarea>

      <!-- Intro is the opening narration -->
      <label for="intro">Intro script</label>
      <textarea id="intro" rows="4" placeholder="Welcome, show positioning, and framing"></textarea>

      <!-- Outro is the closing narration -->
      <label for="outro">Outro script</label>
      <textarea id="outro" rows="4" placeholder="Closing, calls-to-action, credits"></textarea>
      <h2>üéôÔ∏è Segments (dynamic)</h2>
      <!-- Controls to add/remove segment blocks. The actual JS lives in Section 5. -->
      <div class="segment-toolbar">
        <button type="button" id="addSegmentBtn">‚ûï Add segment</button>
        <button type="button" id="removeLastSegmentBtn">‚ûñ Remove last segment</button>
        <small>Each segment includes talking points, a full script, runtime, a transition, and an ad cart.</small>
      </div>

      <!-- Dynamic segments container.
           JS will append segment fieldsets here with unique IDs (segN, segNscript, segNtime, transN, adN). -->
      <div id="segmentsContainer">
        <!-- Seed with one initial segment for usability.
             Additional segments can be added via the "Add segment" button. -->
        <fieldset class="segment-fieldset" data-index="1" draggable="true">
          <legend>Segment 1</legend>

          <!-- Talking points: bullet-style prompts to riff or guide discussion -->
          <label for="seg1">Talking points</label>
          <textarea id="seg1" rows="4" placeholder="Bullet prompts. Use | to separate points."></textarea>
          <small>Tip: Use | between points to create clear breaks.</small>

          <!-- Full script: read-through narration for solo delivery -->
          <label for="seg1script">Segment script</label>
          <textarea id="seg1script" rows="6" placeholder="Full narration for solo recording"></textarea>

          <!-- Estimated runtime: helps pacing and auto-totaling later -->
          <label for="seg1time">Estimated runtime (min)</label>
          <input type="text" id="seg1time" placeholder="e.g., 4‚Äì6" />

          <!-- Transition line: bridge to the next ad or segment -->
          <label for="trans1">Transition line</label>
          <input type="text" id="trans1" placeholder="Bridge into Ad Cart 1 or next segment" />

          <!-- Ad cart copy: sponsor or promo message for this break -->
          <label for="ad1">Ad cart 1</label>
          <textarea id="ad1" rows="3" placeholder="Sponsor/promo copy"></textarea>
        </fieldset>
      </div>
      <h2> Outreach Section</h2>
      <fieldset>
        <legend>Show & Host Info</legend>
        <input type="text" id="showName" placeholder="Show Name" />
        <input type="text" id="hostName" placeholder="Host Name" />
        <input type="text" id="topics" placeholder="Topics Covered" />
        <input type="text" id="guestName" placeholder="Guest Name" />
      </fieldset>

      <fieldset>
        <legend>Recording Details</legend>
        <input type="text" id="recordDate" placeholder="MM/DD/YYYY" pattern="\d{2}/\d{2}/\d{4}" oninput="formatDate(this)" maxlength="10" />
        <input type="time" id="recordTime" onchange="formatTime(this)" data-display="" />
        <input type="text" id="platform" placeholder="Zoom / Riverside / Studio Address" />
      </fieldset>
    </div> <!-- end form-panel -->
    <!-- Right-hand preview panel -->
    <div class="preview-panel">
      <h2>üîç Live Preview</h2>
      <div id="preview"><p>Fill out the form to see your packet preview here.</p></div>
    </div>
  </div> <!-- end container -->

  <!-- Action buttons -->
  <h2>‚öôÔ∏è Actions</h2>
  <button onclick="generatePacket()">Generate Packet</button>
  <button onclick="downloadPacket()">Download Packet</button>
  <button onclick="clearLogo()">Clear Logo</button>
  <button onclick="clearForm()">Clear Form</button>
  
  <!-- Draft management -->
  <h2>üíæ Draft Management</h2>
  <div class="drafts-panel">
    <div class="draft-actions">
      <input type="text" id="draftName" placeholder="Draft name (optional)" />
      <button onclick="saveDraftManually()">Save Current Draft</button>
      <button onclick="deleteAllDrafts()">Delete All Drafts</button>
    </div>
    
    <p class="storage-info">
      <strong>Storage Location:</strong> Browser's IndexedDB at<br>
      <code>PodLab Drafts ‚Üí ${window.location.origin}</code><br>
      <small>Drafts are stored in your browser. They persist until you clear them or clear browser data.</small>
    </p>

    <div class="drafts-list-header">
      <h3>üìù Saved Drafts</h3>
      <span id="draftStatus" class="draft-status"></span>
    </div>
    
    <ul id="draftsList" class="drafts-list">
      <!-- Drafts will be listed here -->
    </ul>
  </div>

  <style>
    .color-picker {
      display: flex;
      align-items: center;
      gap: 0.5em;
    }

    .color-preview {
      width: 24px;
      height: 24px;
      border-radius: 4px;
      border: 1px solid #ccc;
      display: inline-block;
    }

    .text-style-picker {
      display: flex;
      align-items: center;
      gap: 0.5em;
    }

    .text-style-preview {
      padding: 0.4em 0.6em;
      border-radius: 4px;
      border: 1px solid #ccc;
      display: inline-block;
      font-size: 1.2em;
      background: #1c2029;
      min-width: 2em;
      text-align: center;
    }

    /* Segment type styling */
    .segment-fieldset select {
      margin-bottom: 1em;
      width: 100%;
      padding: 8px;
      background: rgba(0,0,0,0.2);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 4px;
      color: #e6e9ef;
    }

    .scripted-fields,
    .guest-fields {
      border-top: 1px solid rgba(255,255,255,0.1);
      padding-top: 1em;
      margin-top: 1em;
    }

    /* Raw HTML controls */
    .raw-html-controls {
      margin: 2em 0;
    }

    .raw-html-controls details {
      background: rgba(0,0,0,0.1);
      padding: 1em;
      border-radius: 8px;
      margin-bottom: 1em;
    }

    .raw-html-controls summary {
      cursor: pointer;
      padding: 0.5em;
      color: #5cc8ff;
    }

    .raw-html-button {
      display: inline-block;
      margin-top: 1em;
    }

    .drafts-panel {
      margin: 1em 0;
      padding: 1.5em;
      background: rgba(0,0,0,0.1);
      border-radius: 8px;
    }
    .draft-actions {
      display: flex;
      gap: 1em;
      margin-bottom: 1em;
      align-items: center;
    }
    #draftName {
      min-width: 200px;
      padding: 0.5em;
      border-radius: 4px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(0,0,0,0.2);
      color: #fff;
    }
    .storage-info {
      padding: 1em;
      background: rgba(0,0,0,0.2);
      border-radius: 4px;
      margin: 1em 0;
      font-size: 0.9em;
    }
    .storage-info code {
      display: inline-block;
      padding: 0.2em 0.4em;
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
      margin: 0.3em 0;
    }
    .drafts-list-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1em;
    }
    .draft-status {
      color: #9aa3b2;
      font-size: 0.9rem;
    }
    .drafts-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 300px;
      overflow-y: auto;
    }
    .drafts-list li {
      display: flex;
      align-items: center;
      gap: 1em;
      padding: 0.8em;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      background: rgba(0,0,0,0.15);
      margin-bottom: 0.5em;
      border-radius: 4px;
    }
    .drafts-list li:last-child {
      margin-bottom: 0;
    }
    .drafts-list .draft-info {
      flex: 1;
    }
    .drafts-list .draft-title {
      display: block;
      font-weight: bold;
      margin-bottom: 0.2em;
    }
    .drafts-list .draft-date {
      color: #9aa3b2;
      font-size: 0.9em;
    }
    .drafts-list .draft-actions {
      display: flex;
      gap: 0.5em;
      margin: 0;
    }
    .drafts-list button {
      padding: 0.4em 0.8em;
      font-size: 0.9em;
      border-radius: 4px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(0,0,0,0.2);
      color: #fff;
      cursor: pointer;
    }
    .drafts-list button:hover {
      background: rgba(255,255,255,0.1);
    }
  </style>

  <!-- Raw HTML output options -->
  <div class="raw-html-controls">
    <details>
      <summary>Advanced: Raw HTML Output</summary>
      <textarea id="output" style="width:100%; height:200px; margin-top:10px;" readonly></textarea>
    </details>
    <button onclick="openRawHtml()" class="raw-html-button">Open in New Window</button>
  </div>

  <script>
    // Open raw HTML in new window
    function openRawHtml() {
      const html = document.getElementById("output").value;
      const w = window.open("", "RawHTML", "width=800,height=600");
      w.document.write(`
        <html>
        <head>
          <title>Raw HTML Output</title>
          <style>
            body { background: #1c2029; color: #e6e9ef; font-family: monospace; padding: 20px; }
            pre { white-space: pre-wrap; word-wrap: break-word; }
          </style>
        </head>
        <body>
          <pre>${html.replace(/</g,"&lt;")}</pre>
        </body>
        </html>
      `);
    }
    // Update color preview swatches
    function updateColorPreview(previewId, color) {
      const preview = document.getElementById(previewId);
      if (preview) {
        preview.style.backgroundColor = color;
      }
    }

    // Update text style preview
    function updateTextStylePreview() {
      const color = document.getElementById("brandText").value;
      const font = document.getElementById("brandFont").value;
      const preview = document.getElementById("brandTextPreview");

      if (preview) {
        preview.style.color = color;
        preview.style.fontFamily = font;
      }
    }

    // Toggle segment type fields
    function toggleSegmentType(select, index) {
      const fs = select.closest("fieldset");
      const scripted = fs.querySelector(".scripted-fields");
      const guest = fs.querySelector(".guest-fields");

      if (select.value === "guest") {
        scripted.style.display = "none";
        guest.style.display = "block";
      } else {
        scripted.style.display = "block";
        guest.style.display = "none";
      }
    }

    // Initialize previews on page load
    window.addEventListener("load", () => {
      updateColorPreview("brandPrimaryPreview", document.getElementById("brandPrimary").value);
      updateColorPreview("brandAccentPreview", document.getElementById("brandAccent").value);
      updateColorPreview("brandBackgroundPreview", document.getElementById("brandBackground").value);
      updateTextStylePreview();
    });

    // Format date as user types
    function formatDate(input) {
      // Remove any non-digit characters
      let value = input.value.replace(/\D/g, '');
      
      // Add slashes as the user types
      if (value.length > 4) {
        value = value.slice(0,2) + '/' + value.slice(2,4) + '/' + value.slice(4);
      } else if (value.length > 2) {
        value = value.slice(0,2) + '/' + value.slice(2);
      }
      
      input.value = value;
    }

    // Format time to 12-hour with AM/PM
    function formatTime(input) {
      const time24 = input.value;
      if (time24) {
        const [hours24, minutes] = time24.split(':');
        const hours = parseInt(hours24);
        const ampm = hours >= 12 ? 'PM' : 'AM';
        const hours12 = hours % 12 || 12;
        const formattedTime = `${hours12}:${minutes} ${ampm}`;
        input.dataset.display = formattedTime;
      }
    }

    // Helper: get field value by ID with date/time formatting
    function get(id) {
      const el = document.getElementById(id);
      if (!el) return "";
      
      // Special handling for recordDate
      if (id === "recordDate") {
        const value = el.value.trim();
        if (value) {
          // Already in MM/DD/YYYY format
          if (/^\d{2}\/\d{2}\/\d{4}$/.test(value)) {
            return value;
          }
          // If somehow in YYYY-MM-DD format, convert it
          const parts = value.split('-');
          if (parts.length === 3) {
            return `${parts[1]}/${parts[2]}/${parts[0]}`;
          }
        }
      }
      // Special handling for recordTime
      if (id === "recordTime") {
        return el.dataset.display || el.value;
      }
      return el.value.trim();
    }

    // -----------------------------
    // IndexedDB Draft Management
    // -----------------------------
    const DB_NAME = 'podlab_drafts';
    const DB_VERSION = 1;
    const DRAFTS_STORE = 'drafts';
    let draftTimer = null;
    let savedLogoData = null; // dataURL stored in draft (we cannot set file input programmatically)
    let db = null;

    // Initialize IndexedDB
    function initDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);

        request.onerror = () => reject(new Error('Failed to open IndexedDB'));

        request.onsuccess = (event) => {
          db = event.target.result;
          resolve(db);
        };

        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          // Create drafts store with timestamp index
          if (!db.objectStoreNames.contains(DRAFTS_STORE)) {
            const store = db.createObjectStore(DRAFTS_STORE, { keyPath: 'id', autoIncrement: true });
            store.createIndex('timestamp', 'timestamp');
            store.createIndex('title', 'title');
          }
        };
      });
    }

    // Save draft to IndexedDB
    async function saveDraftToIndexedDB(data) {
      if (!db) await initDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(DRAFTS_STORE, 'readwrite');
        const store = tx.objectStore(DRAFTS_STORE);

        // Add timestamp and metadata
        const draft = {
          ...data,
          timestamp: new Date().toISOString(),
          title: data.title || 'Untitled Draft',
        };

        const request = store.add(draft);
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(new Error('Failed to save draft'));
      });
    }

    // List all drafts
    async function listDrafts() {
      if (!db) await initDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(DRAFTS_STORE, 'readonly');
        const store = tx.objectStore(DRAFTS_STORE);
        const request = store.index('timestamp').getAll();

        request.onsuccess = () => {
          const drafts = request.result;
          resolve(drafts.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)));
        };
        request.onerror = () => reject(new Error('Failed to list drafts'));
      });
    }

    // Get a specific draft by ID
    async function getDraft(id) {
      if (!db) await initDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(DRAFTS_STORE, 'readonly');
        const store = tx.objectStore(DRAFTS_STORE);
        const request = store.get(id);

        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(new Error('Failed to get draft'));
      });
    }

    // Delete a draft by ID
    async function deleteDraft(id) {
      if (!db) await initDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(DRAFTS_STORE, 'readwrite');
        const store = tx.objectStore(DRAFTS_STORE);
        const request = store.delete(id);

        request.onsuccess = () => resolve();
        request.onerror = () => reject(new Error('Failed to delete draft'));
      });
    }

    // Delete all drafts after confirmation
    async function deleteAllDrafts() {
      if (!confirm('Are you sure you want to delete ALL drafts? This cannot be undone.')) {
        return;
      }
      try {
        const tx = db.transaction(DRAFTS_STORE, 'readwrite');
        const store = tx.objectStore(DRAFTS_STORE);
        await store.clear();
        await updateDraftsListUI();
        showDraftStatus('All drafts deleted');
      } catch (err) {
        showDraftStatus('Failed to delete drafts');
        console.error('Delete all failed:', err);
      }
    }

    // Update drafts list UI
    async function updateDraftsListUI() {
      const drafts = await listDrafts();
      const list = document.getElementById('draftsList');
      if (!list) return;

      list.innerHTML = drafts.length === 0 
        ? '<li class="empty-state">No drafts saved yet. Use "Save Current Draft" to create one.</li>'
        : '';

      drafts.forEach(draft => {
        const date = new Date(draft.timestamp).toLocaleString();
        const li = document.createElement('li');
        li.innerHTML = `
          <div class="draft-info">
            <span class="draft-title">${draft.title || 'Untitled'}</span>
            <span class="draft-date">${date}</span>
          </div>
          <div class="draft-actions">
            <button onclick="restoreDraft(${draft.id})">Restore</button>
            <button onclick="deleteDraft(${draft.id}).then(updateDraftsListUI)">Delete</button>
          </div>
        `;
        list.appendChild(li);
      });
    }

    // Collect form data into a JSON-friendly model
    function collectFormData() {
      const data = {
        title: get('title'),
        description: get('description'),
        intro: get('intro'),
        outro: get('outro'),
        segments: [],
        guestIntro: get('guestIntro'),
        questions: get('questions'),
        showName: get('showName'),
        hostName: get('hostName'),
        topics: get('topics'),
        guestName: get('guestName'),
        recordDate: get('recordDate'),
        recordTime: get('recordTime'),
        platform: get('platform'),
        segmentCount: segmentCount,
        brand: {
          primary: get('brandPrimary') || '#ffd56a',
          accent: get('brandAccent') || '#5cc8ff',
          background: get('brandBackground') || '#0f1115',
          text: get('brandText') || '#ffffff',
          font: get('brandFont') || 'Inter, system-ui, -apple-system, sans-serif'
        },
        logoData: savedLogoData || null
      };

      for (let i = 1; i <= segmentCount; i++) {
        const segmentType = get(`segType${i}`) || 'scripted';
        const segment = {
          type: segmentType,
          runtime: get(`seg${i}time`),
          transition: get(`trans${i}`),
          ad: get(`ad${i}`)
        };

        if (segmentType === 'scripted') {
          segment.talking = get(`seg${i}`);
          segment.script = get(`seg${i}script`);
        } else if (segmentType === 'guest') {
          segment.guestIntro = get(`seg${i}guest`);
          segment.questions = get(`seg${i}questions`);
        }

        data.segments.push(segment);
      }

      return data;
    }

    // -----------------------------
    // Segment drag & drop helpers
    // -----------------------------
    let dragSrcEl = null;

    function makeSegmentDraggable(fs) {
      fs.setAttribute('draggable', 'true');
      fs.addEventListener('dragstart', function(e) {
        dragSrcEl = this;
        e.dataTransfer.effectAllowed = 'move';
        this.classList.add('dragging');
      });
      fs.addEventListener('dragend', function() {
        this.classList.remove('dragging');
      });
    }

    function updateSegmentIndices() {
      const container = document.getElementById('segmentsContainer');
      const children = Array.from(container.querySelectorAll('.segment-fieldset'));
      segmentCount = children.length;
      children.forEach((fs, idx) => {
        const i = idx + 1;
        // Extract current values from the fieldset
        const textareas = fs.querySelectorAll('textarea');
        const inputs = fs.querySelectorAll('input');
        const vals = {
          talking: textareas[0] ? textareas[0].value : '',
          script: textareas[1] ? textareas[1].value : '',
          ad: textareas[2] ? textareas[2].value : '',
          time: inputs[0] ? inputs[0].value : '',
          transition: inputs[1] ? inputs[1].value : ''
        };

        // Rebuild innerHTML with new indices while preserving values
        fs.dataset.index = i;
        fs.innerHTML = `
          <legend>Segment ${i}</legend>
          <label for="seg${i}">Talking points</label>
          <textarea id="seg${i}" rows="4">${escapeHtml(vals.talking)}</textarea>

          <label for="seg${i}script">Segment script</label>
          <textarea id="seg${i}script" rows="6">${escapeHtml(vals.script)}</textarea>

          <label for="seg${i}time">Estimated runtime (min)</label>
          <input type="text" id="seg${i}time" value="${escapeHtml(vals.time)}" />

          <label for="trans${i}">Transition line</label>
          <input type="text" id="trans${i}" value="${escapeHtml(vals.transition)}" />

          <label for="ad${i}">Ad cart ${i}</label>
          <textarea id="ad${i}" rows="3">${escapeHtml(vals.ad)}</textarea>
        `;

        makeSegmentDraggable(fs);
      });
      // Re-wire autosave listeners for new inputs
      wireAutosaveListeners();
    }

    // small helper to escape HTML when injecting values into textarea/input innerHTML
    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }


    // Save current form state as a new draft
    async function saveDraftManually() {
      try {
        const draftName = document.getElementById('draftName').value.trim();
        const episodeTitle = document.getElementById('title').value.trim();
        const finalTitle = draftName || episodeTitle || 'Untitled Draft';
        
        // If a logo file is present, read it as dataURL
        const logoInput = document.getElementById('logo');
        if (logoInput && logoInput.files && logoInput.files.length > 0) {
          const reader = new FileReader();
          reader.onload = async function(e) {
            savedLogoData = e.target.result;
            const payload = {
              ...collectFormData(),
              title: finalTitle
            };
            await saveDraftToIndexedDB(payload);
            showDraftStatus(`Saved as "${finalTitle}"`);
            document.getElementById('draftName').value = ''; // Clear name field
            await updateDraftsListUI();
          };
          reader.readAsDataURL(logoInput.files[0]);
        } else {
          const payload = {
            ...collectFormData(),
            title: finalTitle
          };
          await saveDraftToIndexedDB(payload);
          showDraftStatus(`Saved as "${finalTitle}"`);
          document.getElementById('draftName').value = ''; // Clear name field
          await updateDraftsListUI();
        }
      } catch (err) {
        showDraftStatus('Failed to save draft');
        console.error('Draft save failed:', err);
      }
    }

    // Show a small transient draft status
    let statusTimer = null;
    function showDraftStatus(msg) {
      const el = document.getElementById('draftStatus');
      if (!el) return;
      el.textContent = msg;
      if (statusTimer) clearTimeout(statusTimer);
      statusTimer = setTimeout(() => { el.textContent = ''; }, 2500);
    }

    // Restore draft from IndexedDB by ID
    async function restoreDraft(id) {
      try {
        const data = await getDraft(id);
        // Set simple fields
        document.getElementById('title').value = data.title || '';
        document.getElementById('description').value = data.description || '';
        document.getElementById('intro').value = data.intro || '';
        document.getElementById('outro').value = data.outro || '';
        document.getElementById('guestIntro').value = data.guestIntro || '';
        document.getElementById('questions').value = data.questions || '';
        document.getElementById('showName').value = data.showName || '';
        document.getElementById('hostName').value = data.hostName || '';
        document.getElementById('topics').value = data.topics || '';
        document.getElementById('guestName').value = data.guestName || '';
        document.getElementById('recordDate').value = data.recordDate || '';
        document.getElementById('recordTime').value = data.recordTime || '';
        document.getElementById('platform').value = data.platform || '';

        // Brand kit values
        if (data.brand) {
          document.getElementById('brandPrimary').value = data.brand.primary || '#ffd56a';
          document.getElementById('brandAccent').value = data.brand.accent || '#5cc8ff';
          document.getElementById('brandBackground').value = data.brand.background || '#0f1115';
          document.getElementById('brandFont').value = data.brand.font || 'Inter, system-ui, -apple-system, sans-serif';
        }

        // Rebuild segments UI to match saved segmentCount
        const n = data.segmentCount || data.segments.length || 1;
        const container = document.getElementById('segmentsContainer');
        container.innerHTML = ''; // clear
        segmentCount = 0;
        for (let i = 1; i <= n; i++) {
          segmentCount = i;
          const fs = document.createElement('fieldset');
          fs.className = 'segment-fieldset';
          fs.dataset.index = i;
          fs.innerHTML = `
            <legend>Segment ${i}</legend>
            <label for="seg${i}">Talking points</label>
            <textarea id="seg${i}" rows="4"></textarea>

            <label for="seg${i}script">Segment script</label>
            <textarea id="seg${i}script" rows="6"></textarea>

            <label for="seg${i}time">Estimated runtime (min)</label>
            <input type="text" id="seg${i}time" />

            <label for="trans${i}">Transition line</label>
            <input type="text" id="trans${i}" />

            <label for="ad${i}">Ad cart ${i}</label>
            <textarea id="ad${i}" rows="3"></textarea>
          `;
          container.appendChild(fs);
        
          // ensure new fieldset is draggable
          makeSegmentDraggable(fs);
        }

        // Populate segment values
        if (Array.isArray(data.segments)) {
          for (let i = 0; i < data.segments.length; i++) {
            const s = data.segments[i] || {};
            const idx = i + 1;
            const setVal = (id, val) => { const el = document.getElementById(id); if (el) el.value = val || ''; };
            setVal(`seg${idx}`, s.talking);
            setVal(`seg${idx}script`, s.script);
            setVal(`seg${idx}time`, s.runtime);
            setVal(`trans${idx}`, s.transition);
            setVal(`ad${idx}`, s.ad);
          }
        }

        // Restore logo data if present (we cannot set file input programmatically)
        if (data.logoData) {
          savedLogoData = data.logoData;
          document.querySelector('.logo-block').innerHTML = `<img src="${savedLogoData}" alt="Logo" style="max-width:200px; margin-bottom:20px;" />`;
        }

        // Update preview/output
        generatePacket();
        showDraftStatus('Draft restored');
        updateDraftButtons();
      } catch (e) {
        console.error('Failed to restore draft', e);
      }
    }

    // Clear form and start fresh
    function clearForm() {
      savedLogoData = null;
      // reset brand kit to defaults
      const bp = document.getElementById('brandPrimary'); if (bp) bp.value = '#ffd56a';
      const ba = document.getElementById('brandAccent'); if (ba) ba.value = '#5cc8ff';
      const bb = document.getElementById('brandBackground'); if (bb) bb.value = '#0f1115';
      const bf = document.getElementById('brandFont'); if (bf) bf.value = 'Inter, system-ui, -apple-system, sans-serif';
      
      // Clear all form fields
      document.querySelectorAll('input:not([type="color"]):not([type="file"]), textarea').forEach(el => {
        el.value = '';
      });

      // Reset segments to initial state
      const container = document.getElementById('segmentsContainer');
      if (container) {
        container.innerHTML = '';
        segmentCount = 0;
        document.getElementById('addSegmentBtn').click(); // Add one empty segment
      }

      showDraftStatus('Form cleared');
    }

    // On load: initialize IndexedDB and show drafts list
    window.addEventListener('load', async () => {
      try {
        await initDB();
        await updateDraftsListUI();
        showDraftStatus('Ready to save drafts');
      } catch (err) {
        console.error('Failed to initialize:', err);
        showDraftStatus('Failed to initialize draft system');
      }
      // Make existing seeded segments draggable and wire listeners
      document.querySelectorAll('.segment-fieldset').forEach(fs => makeSegmentDraggable(fs));
      // Wire container drag/drop handlers
      const container = document.getElementById('segmentsContainer');
      if (container) {
        container.addEventListener('dragover', function(e) {
          e.preventDefault();
        });
        container.addEventListener('drop', function(e) {
          e.preventDefault();
          const target = e.target.closest('.segment-fieldset');
          if (!target || !dragSrcEl) return;
          const rect = target.getBoundingClientRect();
          const after = (e.clientY - rect.top) > (rect.height / 2);
          if (after) target.parentNode.insertBefore(dragSrcEl, target.nextSibling);
          else target.parentNode.insertBefore(dragSrcEl, target);
          updateSegmentIndices();
          saveDraftDebounced();
        });
      }
    });

    // Add a new segment dynamically
    let segmentCount = 1; // we seeded Segment 1 in Section 2
    document.getElementById("addSegmentBtn").addEventListener("click", () => {
      segmentCount++;
      const container = document.getElementById("segmentsContainer");

      // Build new fieldset with unique IDs
      const fs = document.createElement("fieldset");
      fs.className = "segment-fieldset";
      fs.dataset.index = segmentCount;
      fs.innerHTML = `
        <legend>Segment ${segmentCount}</legend>
        <label for="segType${segmentCount}">Segment Type</label>
        <select id="segType${segmentCount}" onchange="toggleSegmentType(this, ${segmentCount})">
          <option value="scripted">Scripted (solo)</option>
          <option value="guest">Guest</option>
        </select>

        <div class="scripted-fields">
          <label for="seg${segmentCount}">Talking points</label>
          <textarea id="seg${segmentCount}" rows="4" placeholder="Bullet prompts. Use | to separate points."></textarea>

          <label for="seg${segmentCount}script">Segment script</label>
          <textarea id="seg${segmentCount}script" rows="6" placeholder="Full narration for solo recording"></textarea>
        </div>

        <div class="guest-fields" style="display: none;">
          <label for="seg${segmentCount}guest">Guest Introduction</label>
          <textarea id="seg${segmentCount}guest" rows="3" placeholder="How you'll introduce this guest"></textarea>

          <label for="seg${segmentCount}questions">Guest Questions</label>
          <textarea id="seg${segmentCount}questions" rows="4" placeholder="Q1 | Q2 | Q3 (use | to separate)"></textarea>
        </div>

        <label for="seg${segmentCount}time">Estimated runtime (min)</label>
        <input type="text" id="seg${segmentCount}time" placeholder="e.g., 4-6" />

        <label for="trans${segmentCount}">Transition line</label>
        <input type="text" id="trans${segmentCount}" placeholder="Bridge to next segment or ad" />

        <label for="ad${segmentCount}">Ad cart ${segmentCount}</label>
        <textarea id="ad${segmentCount}" rows="3" placeholder="Sponsor/promo copy"></textarea>
      `;
      container.appendChild(fs);
      // Make the new segment draggable and ensure autosave listeners are attached
      makeSegmentDraggable(fs);
      wireAutosaveListeners();
    });

    // Remove last segment
    document.getElementById("removeLastSegmentBtn").addEventListener("click", () => {
      if (segmentCount > 1) {
        const container = document.getElementById("segmentsContainer");
        container.removeChild(container.lastElementChild);
        segmentCount--;
      }
    });

    // Generate packet HTML
    function generatePacket() {
      // Build brand-aware inline CSS for the packet using brand kit values
      const brand = {
        primary: get('brandPrimary') || '#ffd56a',
        accent: get('brandAccent') || '#5cc8ff',
        background: get('brandBackground') || '#0f1115',
        text: get('brandText') || '#ffffff',
        font: get('brandFont') || 'Inter, system-ui, -apple-system, sans-serif'
      };

      const cssBlock = `
      <style>
        body { background:${brand.background}; color:${brand.text}; font:16px/1.6 ${brand.font}; padding:40px; max-width:900px; margin:auto; }
        h1,h2 { color:${brand.primary}; }
        h3 { color:${brand.accent}; }
        .section { background:rgba(0,0,0,0.12); border-radius:12px; padding:20px; margin-top:20px; border:2px solid rgba(255,255,255,0.03); box-shadow:0 4px 8px rgba(0,0,0,0.4); }
        footer { margin-top:40px; text-align:center; color:#9aa3b2; font-size:0.85rem; }
      </style>
      `;

      let html = `
      <!DOCTYPE html>
      <html lang="en">
      <head><meta charset="utf-8" /><title>${get("title")}</title>${cssBlock}</head>
      <body>
        <div class="logo-block">[LOGO HERE]</div>
        <h1>${get("title")}</h1>
        <p><em>${get("description")}</em></p>
        <div class="section"><h2>Intro</h2><p>${get("intro")}</p></div>
      `;

      // Loop through all segments
      let totalRuntime = 0;
      for (let i = 1; i <= segmentCount; i++) {
        const runtime = get(`seg${i}time`);
        if (runtime) {
          const num = parseFloat(runtime);
          if (!isNaN(num)) totalRuntime += num;
        }
        html += `
        <div class="section">
          <h2>Segment ${i} ${runtime ? "(" + runtime + " min)" : ""}</h2>
          <p><strong>Talking Points:</strong> ${get(`seg${i}`)}</p>
          <p><strong>Script:</strong> ${get(`seg${i}script`)}</p>
          <p><strong>Transition:</strong> ${get(`trans${i}`)}</p>
          <p><strong>Ad ${i}:</strong> ${get(`ad${i}`)}</p>
        </div>
        `;
      }

      // Outro
      html += `
        <div class="section"><h2>Outro</h2><p>${get("outro")}</p></div>
      `;

      // Guest section
      html += `
        <div class="section">
          <h2>Guest Section</h2>
          <p><strong>Intro:</strong> ${get("guestIntro")}</p>
          <p><strong>Questions:</strong> ${get("questions")}</p>
        </div>
      `;

      // Outreach emails
      html += `
        <div class="section">
          <h2>Outreach ‚Äî Initial Invite</h2>
          <p><strong>Subject:</strong> Invitation to join ${get("showName")}</p>
          <p>Dear ${get("guestName")},</p>
          <p>I‚Äôd love to invite you as a guest on <strong>${get("showName")}</strong>, hosted by ${get("hostName")}. In this episode we‚Äôll be covering <em>${get("topics")}</em>.</p>
          <p>Your insights would add tremendous value to our listeners. Please let me know if you‚Äôre available to record on ${get("recordDate")} at ${get("recordTime")} via  ${get("platform")}</p>
          <p>Best regards,<br>${get("hostName")}</p>
        </div>

        <div class="section">
          <h2>Outreach ‚Äî Confirmation & Instructions</h2>
          <p><strong>Subject:</strong> Confirming your appearance on ${get("showName")}</p>
          <p>Dear ${get("guestName")},</p>
          <p>Thank you for agreeing to join us on <strong>${get("showName")}</strong>. We‚Äôll be recording on ${get("recordDate")} at ${get("recordTime")} via ${get("platform")}.</p>
          <p>Please ensure you have a quiet space, headphones, and a stable internet connection. We‚Äôll provide the recording link and instructions before the session.</p>
          <p>Looking forward to a great conversation on <em>${get("topics")}</em>.</p>
          <p>Best,<br>${get("hostName")}</p>
        </div>

        <div class="section">
          <h2>Outreach ‚Äî Thank You</h2>
          <p><strong>Subject:</strong> Thank you for joining ${get("showName")}</p>
          <p>Dear ${get("guestName")},</p>
          <p>It was a pleasure having you on <strong>${get("showName")}</strong>. Your insights on <em>${get("topics")}</em> will resonate with our audience.</p>
          <p>We‚Äôll share the published episode link once it‚Äôs live. Thanks again for your time and expertise.</p>
          <p>Sincerely,<br>${get("hostName")}</p>
        </div>
      `;

      // Runtime total
      html += `
        <div class="section">
          <h2>Total Runtime</h2>
          <p>Estimated total: ${totalRuntime} minutes</p>
        </div>
  <footer>PodLab Episode Packet v2.0 ‚Äî Modular, branded, and ready for recording.</footer>
      </body></html>
      `;

      // Handle logo upload or saved logo data
      const logoInput = document.getElementById("logo");
      if (logoInput && logoInput.files && logoInput.files.length > 0) {
        const reader = new FileReader();
        reader.onload = function(e) {
          html = html.replace("[LOGO HERE]",
            `<img src="${e.target.result}" alt="Logo" style="max-width:200px; margin-bottom:20px;" />`
          );
          document.getElementById("preview").innerHTML = html;
          document.getElementById("output").value = html;
        };
        reader.readAsDataURL(logoInput.files[0]);
      } else if (savedLogoData) {
        html = html.replace("[LOGO HERE]",
          `<img src="${savedLogoData}" alt="Logo" style="max-width:200px; margin-bottom:20px;" />`
        );
        document.getElementById("preview").innerHTML = html;
        document.getElementById("output").value = html;
      } else {
        html = html.replace("[LOGO HERE]", "");
        document.getElementById("preview").innerHTML = html;
        document.getElementById("output").value = html;
      }
    }

    // Download packet
    function downloadPacket() {
      const content = document.getElementById("output").value;
      const blob = new Blob([content], { type: "text/html" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = get("title").replace(/\s+/g, "_") + "_packet.html";
      a.click();
      URL.revokeObjectURL(url);
    }

    // Clear logo
    function clearLogo() {
      const logoInput = document.getElementById("logo");
      logoInput.value = "";
      document.querySelector(".logo-block").innerHTML = "";
      generatePacket();
    }
  </script>
  <!-- Simple footer for the builder interface itself.
       Note: the generated packet already has its own footer injected in Section 5. -->
  <footer>
  <p>PodLab Packet Builder v2.0 ‚Äî Modular, branded, and future‚Äëproof.</p>
    <p><small>Generated with PodLab‚Äôs workflow system. All packets are client‚Äëfriendly and teachable.</small></p>
  </footer>

</body>
</html>
